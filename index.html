<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ–¹å‘æ¡ˆå†…ãƒ‡ãƒ¢ï¼ˆã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã¤ãï¼‰</title>
  <style>
    #arrow {
      width: 100px;
      height: 100px;
      background: red;
      clip-path: polygon(50% 0%, 100% 100%, 50% 80%, 0% 100%);
      margin: 50px auto;
      transform: rotate(0deg);
      transition: transform 0.2s linear;
    }
    #info {
      text-align: center;
      margin: 10px;
    }
    #qrInput {
      display: block;
      margin: 0 auto;
      text-align: center;
    }
    #permissionButton {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <button id="permissionButton">ğŸ“± ã‚¸ãƒ£ã‚¤ãƒ­ã‚’è¨±å¯ã™ã‚‹</button>
  <div id="arrow"></div>
  <div id="info">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ã­</div>
  <input type="text" id="qrInput" placeholder="ä¾‹: cp03,320" />

  <script>
    let northOffset = 0;
    let correctedAlpha = null;
    let permissionGranted = false;

    // è¨±å¯ãƒœã‚¿ãƒ³
    document.getElementById("permissionButton").addEventListener("click", () => {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              permissionGranted = true;
              window.addEventListener("deviceorientation", handleOrientation);
              document.getElementById("info").textContent = "ã‚¸ãƒ£ã‚¤ãƒ­è¨±å¯å®Œäº†ï¼";
            } else {
              alert("ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼");
            }
          })
          .catch(console.error);
      } else {
        // Android or PC
        permissionGranted = true;
        window.addEventListener("deviceorientation", handleOrientation);
        document.getElementById("info").textContent = "ã‚¸ãƒ£ã‚¤ãƒ­æœ‰åŠ¹ä¸­ï¼";
      }
    });

    // QRå…¥åŠ›
    document.getElementById("qrInput").addEventListener("change", function () {
      const qrData = this.value.trim(); // ä¾‹: cp03,320
      const [cpId, angleStr] = qrData.split(",");
      northOffset = parseFloat(angleStr);
      localStorage.setItem("northOffset", northOffset);
      document.getElementById("info").textContent = `ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ ${cpId} / QRã®å‘ã ${northOffset}Â° ã‚’ç™»éŒ²`;
    });

    // ã‚¸ãƒ£ã‚¤ãƒ­å‡¦ç†
    function handleOrientation(e) {
      if (!permissionGranted) return;

      const alpha = e.alpha;
      if (alpha === null) return;

      const storedOffset = parseFloat(localStorage.getItem("northOffset") || "0");

      if (alpha === 0 && localStorage.getItem("correctedAlpha")) {
        correctedAlpha = parseFloat(localStorage.getItem("correctedAlpha"));
      } else {
        correctedAlpha = (alpha + storedOffset) % 360;
        localStorage.setItem("correctedAlpha", correctedAlpha);
      }

      // ä»®ï¼šç›®çš„åœ°ã®è§’åº¦ï¼ˆå›ºå®šï¼‰
      const targetAngle = 135;
      const direction = (targetAngle - correctedAlpha + 360) % 360;

      document.getElementById("arrow").style.transform = `rotate(${direction}deg)`;
      document.getElementById("info").textContent = `ç¾åœ¨ã®å‘ã: ${correctedAlpha.toFixed(1)}Â° â†’ çŸ¢å°: ${direction.toFixed(1)}Â°`;
    }
  </script>
</body>
</html>
