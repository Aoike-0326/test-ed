<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>文化祭案内アプリ</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: sans-serif;
    }
    h1 {
      margin-bottom: 1rem;
    }
    #arrow {
      width: 100px;
      height: 100px;
      transition: transform 0.2s ease;
    }
  </style>
</head>
<body>
  <h1 id="cp-label">チェックポイント</h1>
  <img id="arrow" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Arrow_simple.svg/512px-Arrow_simple.svg.png" alt="矢印">
  <p id="debug"></p>

  <script>
    // URLからクエリ取得
    const urlParams = new URLSearchParams(window.location.search);
    const cpId = urlParams.get("cp") || "unknown";
    const baseAngle = parseFloat(urlParams.get("dir") || "0");
    const targetAngle = parseFloat(urlParams.get("target") || "0");

    document.getElementById("cp-label").textContent = `現在地：${cpId}`;

    // 矢印の向き更新
    function updateArrow(rotation) {
      const arrow = document.getElementById("arrow");
      arrow.style.transform = `rotate(${rotation}deg)`;
    }

    // 方位取得イベント
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    window.addEventListener('deviceorientation', handleOrientation, true); // fallback

    function handleOrientation(event) {
      let alpha = event.alpha;

      if (typeof alpha !== "number") return;

      // 現在の方位（基準調整）
      let currentHeading = alpha;

      // iOS Safari の補正
      if (event.webkitCompassHeading !== undefined) {
        currentHeading = event.webkitCompassHeading;
      }

      // 実際の向き（基準角から見て）
      const relativeHeading = (currentHeading - baseAngle + 360) % 360;

      // 矢印が指すべき角度（相対的）
      const angleToTarget = (targetAngle - relativeHeading + 360) % 360;

      updateArrow(angleToTarget);
      document.getElementById("debug").textContent =
        `現在角: ${Math.round(currentHeading)}°, 目標角: ${targetAngle}°, 相対角: ${Math.round(angleToTarget)}°`;
    }
  </script>
</body>
</html>
